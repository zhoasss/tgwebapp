# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–µ–π –≤ Telegram Mini App

## –ü—Ä–æ–±–ª–µ–º–∞

–ó–∞–ø–∏—Å–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ **Telegram Mini App** (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏), —Ö–æ—Ç—è —Ä–∞–±–æ—Ç–∞–ª–∏ –≤ **–≤–µ–±-–≤–µ—Ä—Å–∏–∏** (–±—Ä–∞—É–∑–µ—Ä–µ).

## –ü—Ä–∏—á–∏–Ω—ã

### 1. **–°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ initData**
–í —Ñ–∞–π–ª–µ `frontend/src/pages/records/records.js` —Ñ—É–Ω–∫—Ü–∏—è `loadRecords()` –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –Ω–∞–ª–∏—á–∏–µ `window.Telegram?.WebApp?.initData` **–ø–µ—Ä–µ–¥** –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ localStorage:

```javascript
// ‚ùå –°–¢–ê–†–´–ô –ö–û–î - –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É
if (!window.Telegram?.WebApp?.initData) {
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
    return;
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage, –∫–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É –∑–∞–ø–∏—Å–µ–π –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è initData.

### 2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã**
–§—É–Ω–∫—Ü–∏—è `initRecordsPage()` —Ç–∞–∫–∂–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ –Ω–∞–ª–∏—á–∏—è Telegram WebApp –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—è –Ω–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤.

### 3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API**
–í `jwt-auth.js` –º–µ—Ç–æ–¥ `_checkAuthStatus()` –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Ç–æ–∫–µ–Ω –∏–∑ localStorage –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization, –ø–æ–ª–∞–≥–∞—è—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ cookies, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ iframe Telegram.

## –†–µ—à–µ–Ω–∏—è

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ loadRecords()**
```javascript
// ‚úÖ –ù–û–í–´–ô –ö–û–î - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–µ—Ä–≤—ã–º
const hasToken = localStorage.getItem('access_token');

// –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –ò –Ω–µ—Ç initData - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
if (!hasToken && !window.Telegram?.WebApp?.initData) {
    console.error('‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∏ –Ω–µ—Ç initData –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
    return;
}

console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞:', hasToken ? '—á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω' : '—á–µ—Ä–µ–∑ initData');
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –∑–∞–ø–∏—Å–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è initData.

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã**
```javascript
// ‚úÖ –ù–û–í–´–ô –ö–û–î - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–æ–∫–µ–Ω–∞–º
const hasToken = localStorage.getItem('access_token');

// –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏
if (hasToken) {
    console.log('‚úÖ –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏...');
    loadRecords();
}
// –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
else if (!window.Telegram?.WebApp) {
    console.error('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞');
    showError('–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram...');
    return;
}
// –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ Telegram WebApp –µ—â–µ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω.

### 3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ _checkAuthStatus()**
```javascript
// ‚úÖ –ù–û–í–´–ô –ö–û–î - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
const token = localStorage.getItem('access_token');
const headers = {
    'Content-Type': 'application/json',
};

if (token) {
    headers['Authorization'] = `Bearer ${token}`;
}

const response = await fetch(`${API_BASE_URL}/api/auth/protected`, {
    method: 'GET',
    headers: headers,
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–æ–∫–µ–Ω –∏–∑ localStorage —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–µ–µ —á–µ–º cookies –≤ iframe.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è Telegram Mini Apps?

1. **iframe –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: Telegram Mini Apps —Ä–∞–±–æ—Ç–∞—é—Ç –≤ iframe, –≥–¥–µ cookies –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º (–æ—Å–æ–±–µ–Ω–Ω–æ Safari)
2. **localStorage –Ω–∞–¥–µ–∂–Ω–µ–µ**: localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ iframe –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: initData –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, –Ω–æ —Ç–æ–∫–µ–Ω—ã —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã

### Backend –ø–æ–¥–¥–µ—Ä–∂–∫–∞

Backend —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ –º–µ—Ç–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- **Cookies** (HttpOnly, Secure, SameSite=None)
- **Authorization header** (Bearer token)

–ö–æ–¥ –≤ `backend/src/shared/auth/jwt_auth.py`:
```python
async def get_current_user(
    access_token: Optional[str] = Cookie(None, alias="access_token"),
    refresh_token: Optional[str] = Cookie(None, alias="refresh_token"),
    credentials: HTTPAuthorizationCredentials = Depends(security),
    session: AsyncSession = Depends(get_session)
) -> Dict[str, Any]:
    # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ cookies
    if access_token:
        token = access_token
    # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤ cookies –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–±—É–µ–º Authorization header
    elif credentials:
        token = credentials.credentials
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –ó–∞–ø–∏—Å–∏ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –≤ –≤–µ–±-–≤–µ—Ä—Å–∏–∏, —Ç–∞–∫ –∏ –≤ Telegram Mini App
‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å cookies –≤ iframe
‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `frontend/src/pages/records/records.js` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. `frontend/src/shared/lib/jwt-auth.js` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ API –∑–∞–ø—Ä–æ—Å–∞—Ö

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram Mini App
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–ø–∏—Å–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:
```
‚úÖ –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏...
üì° –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π –∏–∑ API...
‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞: —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω
‚úÖ –ó–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ API: X
```
