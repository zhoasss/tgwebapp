/**
 * Auth Guard - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü
 * –°–ª–æ–π App - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
 */

import { requireAuth, isAuthenticated, validateInitData } from '../../../shared/lib/auth.js';
import { getTelegramWebApp } from '../../../shared/lib/telegram.js';

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞—â–∏—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 */
export function initAuthGuard() {
  console.log('üîí –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Auth Guard...');
  
  const tg = getTelegramWebApp();
  
  // –ï—Å–ª–∏ Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
  if (!tg) {
    console.error('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    showUnauthorizedError('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞');
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å initData
  if (!validateInitData()) {
    console.error('‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    showUnauthorizedError('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.');
    return false;
  }
  
  // –¢—Ä–µ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const authenticated = requireAuth(() => {
    // Callback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    blockAppAccess();
  });
  
  if (!authenticated) {
    blockAppAccess();
    return false;
  }
  
  console.log('‚úÖ Auth Guard: –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω');
  
  // –ì–æ—Ç–æ–≤–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ —Ä–∞–±–æ—Ç–µ
  tg.ready();
  tg.expand();
  
  return true;
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –æ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ
 */
function showUnauthorizedError(message) {
  // –°–æ–∑–¥–∞–µ–º overlay —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
  const overlay = document.createElement('div');
  overlay.id = 'auth-error-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-body, #fff);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    text-align: center;
    max-width: 400px;
  `;
  
  content.innerHTML = `
    <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
    <h2 style="color: var(--text-primary, #333); margin-bottom: 16px;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
    <p style="color: var(--text-secondary, #666); margin-bottom: 24px; line-height: 1.5;">
      ${message}
    </p>
    <p style="color: var(--text-secondary, #666); font-size: 14px;">
      –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram –∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å –∫–∞–±–∏–Ω–µ—Ç"
    </p>
  `;
  
  overlay.appendChild(content);
  document.body.appendChild(overlay);
}

/**
 * –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
 */
function blockAppAccess() {
  console.log('üö´ –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
  
  // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
  const app = document.getElementById('app');
  if (app) {
    app.style.display = 'none';
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
  showUnauthorizedError(
    '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.'
  );
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    const tg = getTelegramWebApp();
    if (tg && typeof tg.close === 'function') {
      tg.close();
    }
  }, 5000);
}

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
 */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    initAuthGuard();
  });
} else {
  initAuthGuard();
}

