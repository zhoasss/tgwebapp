# 🚀 Логика запуска и работы приложения

## 📱 Полный Flow работы приложения

### 1️⃣ Пользователь нажимает кнопку в боте

**Действие:** Пользователь в Telegram боте нажимает "Открыть кабинет 🚀"

**Что происходит:**
```
Telegram бот → Отправляет команду /start
              → Показывает кнопку с WebApp URL
              → Пользователь нажимает кнопку
              → Telegram открывает WebApp
```

---

### 2️⃣ WebApp начинает загружаться

**Экран:** Показывается индикатор загрузки

```
┌─────────────────────────┐
│                         │
│         ⭕              │
│   Подключение к         │
│   Telegram...           │
│                         │
└─────────────────────────┘
```

**Код:** `frontend/src/app/providers/auth/guard.js`

```javascript
// Автоматически запускается при загрузке страницы
await initAuthGuard();
  └─> showLoadingOverlay('Подключение к Telegram...')
```

---

### 3️⃣ Проверка авторизации через Telegram

**Этапы проверки:**

#### Этап 1: Проверка Telegram WebApp
```javascript
const tg = getTelegramWebApp();
if (!tg) {
  ❌ ОШИБКА: "Приложение должно быть открыто через Telegram бота"
}
```

**Индикатор:** "Проверка авторизации..."

#### Этап 2: Проверка initData
```javascript
if (!validateInitData()) {
  ❌ ОШИБКА: "Невалидные данные авторизации"
}
```

#### Этап 3: Проверка данных пользователя
```javascript
const user = getTelegramUser();
if (!user || !user.id) {
  ❌ ОШИБКА: "Данные пользователя отсутствуют"
}
```

**Результат:**
- ✅ Все проверки пройдены → Переход к шагу 4
- ❌ Хотя бы одна не прошла → Показывается ошибка и блокировка доступа

---

### 4️⃣ Загрузка/создание данных пользователя

**Индикатор:** "Загрузка данных..."

**API запрос:** `GET /api/profile/`

```javascript
const apiProfile = await getProfile();
```

**На backend происходит:**

1. **Проверка авторизации:**
   ```python
   # backend/src/shared/auth/telegram_auth.py
   telegram_user = get_telegram_user(initData)
   if not valid:
       return 401 Unauthorized
   ```

2. **Поиск пользователя в БД:**
   ```python
   # backend/src/features/api/profile.py
   user = session.query(User).filter_by(
       telegram_id=telegram_user['id']
   ).first()
   ```

3. **Создание нового пользователя (если не найден):**
   ```python
   if not user:
       # Первый запуск - создаем нового пользователя
       user = User(
           telegram_id=telegram_user['id'],
           first_name=telegram_user['first_name'],
           last_name=telegram_user.get('last_name'),
           username=telegram_user.get('username')
       )
       session.add(user)
       session.commit()
       
       print('✨ Создан новый пользователь!')
   ```

4. **Возврат данных:**
   ```python
   return user.to_dict()
   ```

**На frontend обрабатываем ответ:**

```javascript
const isNewUser = !apiProfile.phone && 
                  !apiProfile.business_name && 
                  !apiProfile.address;

if (isNewUser) {
  // Новый пользователь - показываем приветствие
  showNotification('Добро пожаловать! Заполните свой профиль.');
  console.log('✨ Новый пользователь! Создан профиль');
} else {
  // Существующий пользователь - данные загружены
  console.log('✅ Профиль загружен из БД');
}

// Обновляем UI
updateProfileUI();
```

---

### 5️⃣ Успешная загрузка → Пользователь может работать

**Экран:** Показывается профиль пользователя

```
┌─────────────────────────────┐
│  👤 Иван Иванов            │
│  @ivan                     │
│                            │
│  📞 Телефон: +7 999...     │
│  🏢 Бизнес: Салон красоты  │
│  📍 Адрес: ул. Ленина, 10  │
│                            │
│  [Редактировать профиль]   │
└─────────────────────────────┘
```

**Консоль:**
```
✅ Auth Guard: Авторизация успешна
🌐 Загрузка профиля из API...
✅ Профиль загружен из БД
🎉 Профиль успешно загружен. Пользователь может работать!
```

**Пользователь может:**
- ✅ Просматривать свой профиль
- ✅ Редактировать данные
- ✅ Сохранять изменения
- ✅ Пользоваться всеми функциями приложения

---

### 6️⃣ Обработка ошибок

#### Ошибка 1: Telegram WebApp недоступен
```
🔒 Доступ запрещен
━━━━━━━━━━━━━━━━━
Приложение должно быть открыто 
через Telegram бота.

Откройте бота в Telegram и 
нажмите "Открыть кабинет"

⏱️ Закроется через 5 секунд...
```

#### Ошибка 2: Ошибка авторизации
```
🔒 Доступ запрещен
━━━━━━━━━━━━━━━━━
Невалидные данные авторизации.
Пожалуйста, перезапустите бота.
```

#### Ошибка 3: Нет связи с сервером
```
⚠️ Ошибка загрузки
━━━━━━━━━━━━━━━━━
Нет связи с сервером.
Проверьте подключение к интернету.
```

#### Ошибка 4: Ошибка на сервере
```
⚠️ Ошибка загрузки
━━━━━━━━━━━━━━━━━
Не удалось загрузить данные профиля.
Попробуйте позже.
```

---

## 🔄 Диаграмма полного Flow

```
┌─────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ В TELEGRAM                                    │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
         Нажимает кнопку
         "Открыть кабинет 🚀"
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  WEBAPP ЗАГРУЖАЕТСЯ                                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Индикатор: "Подключение к Telegram..."              │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
         🔒 Auth Guard
         Проверка авторизации
                 │
        ┌────────┴────────┐
        │                 │
        ▼                 ▼
     ✅ ОК            ❌ Ошибка
        │                 │
        │                 ▼
        │         Показать ошибку
        │         Заблокировать доступ
        │         Закрыть через 5 сек
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│  ЗАГРУЗКА ДАННЫХ                                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Индикатор: "Загрузка данных..."                      │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
         API: GET /api/profile/
         (с X-Init-Data header)
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  BACKEND: Проверка авторизации                              │
│  └─> Валидация initData через HMAC-SHA256                   │
└────────────────┬────────────────────────────────────────────┘
                 │
        ┌────────┴────────┐
        │                 │
        ▼                 ▼
   ✅ Валидно       ❌ Невалидно
        │                 │
        │                 ▼
        │          401 Unauthorized
        │                 │
        │                 ▼
        │         Frontend: Показать ошибку
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│  BACKEND: Поиск/создание пользователя                       │
│                                                             │
│  user = БД.найти(telegram_id)                              │
│                                                             │
│  if not user:                                               │
│      user = создать_нового(telegram_id, first_name, ...)   │
│      БД.сохранить(user)                                     │
│      ✨ "Новый пользователь создан!"                        │
│                                                             │
│  return user.данные()                                       │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
         Frontend получает данные
                 │
        ┌────────┴────────┐
        │                 │
        ▼                 ▼
   Новый юзер      Существующий
        │                 │
        ▼                 ▼
  "Добро          Загрузить
  пожаловать!"    данные профиля
        │                 │
        └────────┬────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  🎉 УСПЕХ! ПОЛЬЗОВАТЕЛЬ МОЖЕТ РАБОТАТЬ                     │
│                                                             │
│  ✅ Авторизация пройдена                                   │
│  ✅ Данные загружены/созданы                               │
│  ✅ Интерфейс отображается                                 │
│  ✅ Все функции доступны                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 Примеры консольных логов

### Успешный запуск (новый пользователь)

```javascript
// Frontend Console:
🔒 Инициализация Auth Guard...
✅ Auth Guard: Авторизация успешна
📡 Загрузка данных профиля...
👤 Данные пользователя из Telegram: {id: 1170127102, first_name: "Roman", ...}
🌐 Загрузка профиля из API...
✨ Новый пользователь! Создан профиль: {telegram_id: 1170127102, ...}
🎉 Профиль успешно загружен. Пользователь может работать!
```

```python
# Backend Logs:
INFO - 📡 Запрос профиля для пользователя 1170127102
INFO - ✨ Создание нового пользователя 1170127102
INFO - ✅ Профиль получен для пользователя 1170127102
```

### Успешный запуск (существующий пользователь)

```javascript
// Frontend Console:
🔒 Инициализация Auth Guard...
✅ Auth Guard: Авторизация успешна
📡 Загрузка данных профиля...
🌐 Загрузка профиля из API...
✅ Профиль загружен из БД: {telegram_id: 1170127102, phone: "+7 999...", ...}
🎉 Профиль успешно загружен. Пользователь может работать!
```

```python
# Backend Logs:
INFO - 📡 Запрос профиля для пользователя 1170127102
INFO - ✅ Профиль получен для пользователя 1170127102
```

---

## 🔐 Безопасность на каждом этапе

| Этап | Проверка | Действие при ошибке |
|------|----------|---------------------|
| 1. Загрузка | Telegram WebApp доступен? | Блокировка + ошибка |
| 2. Авторизация | initData валиден? | Блокировка + ошибка |
| 3. Данные | user.id существует? | Блокировка + ошибка |
| 4. API | HMAC подпись верна? | 401 Unauthorized |
| 5. БД | Данные созданы/загружены? | Показать ошибку |

---

## ⏱️ Время выполнения

| Этап | Время |
|------|-------|
| Загрузка WebApp | ~500ms |
| Проверка авторизации | ~500ms |
| API запрос + БД | ~200-500ms |
| **Всего** | **~1-1.5 секунды** |

---

## ✅ Критерии успешного запуска

Пользователь может работать, когда:

1. ✅ Telegram WebApp инициализирован
2. ✅ initData валиден и содержит hash
3. ✅ user.id получен из Telegram
4. ✅ Backend проверил HMAC подпись
5. ✅ Пользователь найден или создан в БД
6. ✅ Данные профиля загружены на frontend
7. ✅ UI обновлён и показывает данные

**Результат:** 🎉 Пользователь видит свой профиль и может им управлять!

---

## 🎯 Итог

**Логика работы:**
1. Кнопка → WebApp загружается
2. Показывается индикатор "Подключение..."
3. Проверка авторизации Telegram
4. Загрузка/создание данных из БД
5. Успех → пользователь работает
6. Ошибка → понятное сообщение + блокировка

**Всё автоматически и прозрачно для пользователя! ✨**

